#!/usr/bin/env bash
set -euo pipefail

: "${DIFF:=diff}"

print_help() {
    echo "Usage: clingy {format,check} directory"
}

if [[ $# -lt 2 ]]; then
    print_help
    exit 1
fi

tool=$1
directory=$2
shift
shift

files=$(mktemp)
find "${directory}" -type f \
    -iname \*.c -o \
    -iname \*.c++ -o \
    -iname \*.cc -o \
    -iname \*.cpp -o \
    -iname \*.cxx -o \
    -iname \*.h -o \
    -iname \*.h++ -o \
    -iname \*.hh -o \
    -iname \*.hpp -o \
    -iname \*.hxx > "${files}"

case "${tool}" in
format)
    xargs clang-format -i "$@" < "${files}"
    ;;
check)
    code=0
    while read -r file; do
        clang-format "$@" "${file}" | ${DIFF} -u "${file}" - || code=1
    done < "${files}"
    exit ${code}
    ;;
*)
    print_help
    exit 1
esac
